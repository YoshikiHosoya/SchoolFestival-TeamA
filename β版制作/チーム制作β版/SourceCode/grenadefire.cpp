// =====================================================================================================================================================================
//
// グレネード発射の処理 [grenadefire.cpp]
// Author : Sato Yoshiki
//
// =====================================================================================================================================================================
#include "grenadefire.h"			// インクルードファイル
#include "manager.h"
#include "renderer.h"
#include "game.h"
#include "debugproc.h"
#include "texture.h"
#include "Player.h"
#include "TexAnimation3D_Collision.h"
#include "bullet.h"
#include "grenade.h"

// =====================================================================================================================================================================
// 静的メンバ変数の初期化
// =====================================================================================================================================================================

// =====================================================================================================================================================================
// マクロ定義
// =====================================================================================================================================================================
#define GRENADE_ADD_AMMO			(10)			// グレネードの増える弾数量

// =====================================================================================================================================================================
//
// コンストラクタ
//
// =====================================================================================================================================================================
CGrenadeFire::CGrenadeFire(OBJ_TYPE type) :CScene(type)
{
}

// =====================================================================================================================================================================
//
// デストラクタ
//
// =====================================================================================================================================================================
CGrenadeFire::~CGrenadeFire()
{
}

// =====================================================================================================================================================================
//
// 初期化処理
//
// =====================================================================================================================================================================
HRESULT CGrenadeFire::Init()
{
	m_nAmmo = CBullet::GetBulletParam(CGun::GUNTYPE_GRENADE)->nAmmo;	// 残弾数

	return S_OK;
}

// =====================================================================================================================================================================
//
// 終了処理
//
// =====================================================================================================================================================================
void CGrenadeFire::Uninit(void)
{
}

// =====================================================================================================================================================================
//
// 更新処理
//
// =====================================================================================================================================================================
void CGrenadeFire::Update(void)
{
	// インターバルカウントアップ
	m_nInterval++;
}

// =====================================================================================================================================================================
//
// 描画処理
//
// =====================================================================================================================================================================
void CGrenadeFire::Draw(void)
{
}

// =====================================================================================================================================================================
//
// デバッグ
//
// =====================================================================================================================================================================
void CGrenadeFire::DebugInfo(void)
{
}

// =====================================================================================================================================================================
//
// グレネード放つ位置の生成
//
// =====================================================================================================================================================================
CGrenadeFire * CGrenadeFire::Create(D3DXMATRIX * mtx)
{
	// 変数
	CGrenadeFire *pGrenadeFire;

	// メモリの確保
	pGrenadeFire = new CGrenadeFire(OBJTYPE_MODEL);

	// 初期化
	pGrenadeFire->Init();

	// マトリックス代入
	pGrenadeFire->m_mtx = mtx;

	return pGrenadeFire;
}

// =====================================================================================================================================================================
//
// グレネード放つ
//
// =====================================================================================================================================================================
void CGrenadeFire::Fire(D3DXVECTOR3 rot)
{
	CGrenade *pGrenade = nullptr;

	// グレネードの生成
	pGrenade = CGrenade::Create(rot);

	// 残弾数を減らす
	m_nAmmo--;

	// インターバルが経過したとき
	if (m_nInterval >= CBullet::GetBulletParam(CGun::GUNTYPE_GRENADE)->nInterval)
	{
		m_nInterval = 0;

		if (pGrenade)
		{
			D3DXVECTOR3 pos = D3DXVECTOR3(0.0f, 0.0, 0.0f);
			D3DXVec3TransformCoord(&pos, &D3DXVECTOR3(0.0f, 0.0f, 0.0f), m_mtx);

			// 位置の設定
			pGrenade->SetPosition(pos);

			// タグの設定
			pGrenade->SetTag(m_Tag);

			// 弾のパラメーターの設定
			pGrenade->SetBulletParam(CGun::GUNTYPE_GRENADE);
		}
	}
}

// =====================================================================================================================================================================
//
// グレネードの弾数追加
//
// =====================================================================================================================================================================
void CGrenadeFire::GrenadeAddAmmo()
{
	m_nAmmo += GRENADE_ADD_AMMO;
}