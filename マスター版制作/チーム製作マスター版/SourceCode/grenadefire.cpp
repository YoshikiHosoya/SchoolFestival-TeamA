// =====================================================================================================================================================================
//
// グレネード発射の処理 [grenadefire.cpp]
// Author : Sato Yoshiki
//
// =====================================================================================================================================================================
#include "grenadefire.h"			// インクルードファイル
#include "manager.h"
#include "renderer.h"
#include "game.h"
#include "debugproc.h"
#include "texture.h"
#include "Player.h"
#include "bullet.h"
#include "grenade.h"
#include "sound.h"

// =====================================================================================================================================================================
// 静的メンバ変数の初期化
// =====================================================================================================================================================================

// =====================================================================================================================================================================
// マクロ定義
// =====================================================================================================================================================================
#define GRENADE_ADD_AMMO			(10)			// グレネードの増える弾数量
#define MAX_GRENADE_AMMO			(99)			// グレネードの残数の最大値

// =====================================================================================================================================================================
//
// コンストラクタ
//
// =====================================================================================================================================================================
CGrenadeFire::CGrenadeFire(OBJ_TYPE type) :CScene(type)
{
	m_nAmmo			= 0;				// 残弾数
	m_nInterval		= 0;				// インターバル
	m_type			= HAND_GRENADE;		// グレネードの種類
}

// =====================================================================================================================================================================
//
// デストラクタ
//
// =====================================================================================================================================================================
CGrenadeFire::~CGrenadeFire()
{
}

// =====================================================================================================================================================================
//
// 初期化処理
//
// =====================================================================================================================================================================
HRESULT CGrenadeFire::Init()
{
	SetGrenadeAmmoDefault();

	return S_OK;
}

// =====================================================================================================================================================================
//
// 終了処理
//
// =====================================================================================================================================================================
void CGrenadeFire::Uninit(void)
{
}

// =====================================================================================================================================================================
//
// 更新処理
//
// =====================================================================================================================================================================
void CGrenadeFire::Update(void)
{
	// インターバルカウントアップ
	m_nInterval++;

	// 残弾数の最大値
	if (m_nAmmo >= MAX_GRENADE_AMMO)
	{
		m_nAmmo = MAX_GRENADE_AMMO;
	}
}

// =====================================================================================================================================================================
//
// 描画処理
//
// =====================================================================================================================================================================
void CGrenadeFire::Draw(void)
{
}

// =====================================================================================================================================================================
//
// デバッグ
//
// =====================================================================================================================================================================
void CGrenadeFire::DebugInfo(void)
{
}

// =====================================================================================================================================================================
//
// グレネード放つ位置の生成
//
// =====================================================================================================================================================================
CGrenadeFire * CGrenadeFire::Create(D3DXMATRIX * mtx, GRENADE_TYPE type)
{
	// 変数
	CGrenadeFire *pGrenadeFire;

	// メモリの確保
	pGrenadeFire = new CGrenadeFire(OBJTYPE_MODEL);

	pGrenadeFire->m_type = type;

	// 初期化
	pGrenadeFire->Init();

	// マトリックス代入
	pGrenadeFire->m_mtx = mtx;

	return pGrenadeFire;
}

// =====================================================================================================================================================================
//
// グレネード放つ
//
// =====================================================================================================================================================================
void CGrenadeFire::Fire(D3DXVECTOR3 rot)
{
	CGrenade				*pGrenade		= nullptr;
	CBullet::BULLET_PARAM	*pBulletParam	= nullptr;

	// グレネードの生成
	pGrenade = CGrenade::Create(rot, m_type);

	// パラメーター取得
	switch (m_type)
	{
	case CGrenadeFire::HAND_GRENADE:
		pBulletParam = CBullet::GetBulletParam(CGun::GUNTYPE_HANDGRENADE);
		break;
	case CGrenadeFire::TANK_GRENADE:
		pBulletParam = CBullet::GetBulletParam(CGun::GUNTYPE_TANKGRENADE);
		break;
	}

	// インターバルが経過したとき
	if (m_nInterval >= pBulletParam->nInterval)
	{
		// 残弾数を減らす
		m_nAmmo--;

		m_nInterval = 0;

		if (pGrenade)
		{
			D3DXVECTOR3 pos = ZeroVector3;
			D3DXVec3TransformCoord(&pos, &ZeroVector3, m_mtx);

			// 位置の設定
			pGrenade->SetPosition(pos);

			// タグの設定
			pGrenade->SetTag(m_Tag);

			// 弾のパラメーターの設定
			switch (m_type)
			{
			case CGrenadeFire::HAND_GRENADE:
				pGrenade->SetBulletParam(CGun::GUNTYPE_HANDGRENADE);
				break;
			case CGrenadeFire::TANK_GRENADE:
				pGrenade->SetBulletParam(CGun::GUNTYPE_TANKGRENADE);
				CManager::GetSound()->Play(CSound::LABEL_SE_EXPLOSION_00);
				break;
			}
		}
	}
}

// =====================================================================================================================================================================
//
// グレネードの弾数初期設定
//
// =====================================================================================================================================================================
void CGrenadeFire::SetGrenadeAmmoDefault()
{
	// 残弾数
	switch (m_type)
	{
	case CGrenadeFire::HAND_GRENADE:
		m_nAmmo = CBullet::GetBulletParam(CGun::GUNTYPE_HANDGRENADE)->nAmmo;
		break;
	case CGrenadeFire::TANK_GRENADE:
		m_nAmmo = CBullet::GetBulletParam(CGun::GUNTYPE_TANKGRENADE)->nAmmo;
		break;
	}
}

// =====================================================================================================================================================================
//
// グレネードの弾数追加
//
// =====================================================================================================================================================================
void CGrenadeFire::GrenadeAddAmmo()
{
	m_nAmmo += GRENADE_ADD_AMMO;
}